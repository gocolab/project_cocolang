{% extends "templates/main_template.html"%}
{% block title %}
Debugging Coding Test
{% endblock %}

{% block customize_css %}
<style>
  #notification-container >.toast {
    max-width: none;
    /* 최대 넓이 제한 없애기 */
    width: auto;
    /* 내용에 따라 넓이 자동 조정 */
  }
  .td-setup-min-width {
    min-width: 10rem; /* 원하는 최소 넓이 값으로 조정 */
  }
  
</style>
{% endblock %}

{% block main_container %}
<!-- <div id="notification-container"> -->
<div id="notification-container" class="position-fixed start-50 translate-middle" style="z-index: 1050;">
  <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
  </div>
</div>

<form>
  <!-- 검색 항목 추가 필요 -->
  <div class="row">
    <div class="col-2">
      <select class="form-select" name="key_name">
        <option value="title" {{ 'selected' if request._query_params.key_name=='title' else '' }}>title</option>
        <option value="language_name" {{ 'selected' if request._query_params.key_name=='language_name' else '' }}>
          language</option>
        <option value="framework_name" {{ 'selected' if request._query_params.key_name=='framework_name' else '' }}>
          framework</option>
        <option value="database_name" {{ 'selected' if request._query_params.key_name=='database_name' else '' }}>email
        </option>
      </select>
    </div>
    <div class="col-6">
      <input class="form-control" placeholder="Enter Search!" name="word" value="{{request._query_params.word}}">
    </div>
    <div class="col-4">
      <button type="submit" class="btn btn-primary" formaction="/{{main_router}}/list" formmethod="get">Search</button>
      {% if request.state.user and "PARTNER" in request.state.user.roles %}
      <button type="submit" class="btn btn-danger" formaction="/{{main_router}}/form" formmethod="get">Insert</button>
      {% endif %}
    </div>
  </div>
  <table class="table table-hover">
    <thead>
      <tr class="text-center">
        <th>No.</th>
        <th>Title</th>
        <th>Language</th>
        <th>Framework</th>
        <th>Database</th>
        <th class="td-setup-min-width">Setup</th>
        <th>More</th>
      </tr>
    </thead>
    <tbody>
      {% for comodule in comodules %}
      <tr>
        <td>{{pagination.start_record_number + loop.index}}</td>
        <td>
          {% if request.state.user and "PARTNER" in request.state.user.roles %}
          <a href="/{{main_router}}/{{ comodule.id }}" class="text-decoration-none">{{ comodule.title }}</a>
          {% else %}
          {{ comodule.title }}
          {% endif %}
        </td>
        <td>
          {{comodule.language_name}}{{ "(" + comodule.language_version + ")" if comodule.language_version else "" }}
        </td>
        <td>
          {{comodule.framework_name}}{{ "(" + comodule.framework_version + ")" if comodule.framework_version else "" }}
        </td>
        <td>
          {{comodule.database_name}}{{ "(" + comodule.database_version + ")" if comodule.database_version else "" }}
        </td>
        <td class="text-center">
          <a href="/comodules/download/{{ comodule.id }}" class="btn btn-sm btn-info" id="download_all">
            zip <i class="bi bi-cloud-download"></i>
          </a>
          <button class="btn btn-sm btn-info copyButton"
            value="{{comodule.language_name}}_{{comodule.framework_name}}_{{comodule.database_name}}">
            copy <i class="bi bi-clipboard"></i>
          </button>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip"
            title="pkgs : {{ comodule.required_packages_versions }}">
            <i class="bi bi-chat-left-dots"></i>
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endblock %}
  {% block paginations_container %}
  {% include 'templates/pagination_template.html' %}
</form>
{% endblock %}

{% block foot_javascripts %}

<script>
  document.querySelectorAll('.copyButton').forEach(button => {
    button.addEventListener('click', function (event) {
      event.preventDefault();

      // 'this'를 다른 변수에 할당
      const self = this;
      createToast(self);
    });
  });

  function createToast(thisButton) {
    const buttonValue = thisButton.value.toLowerCase(); // 혹은 this.getAttribute('data-value') 등을 사용

    let toastEl = document.querySelector('.toast');

    let command = `docker-compose --project-name ${buttonValue} up -d --build`;
    const os = require('os');
    
    let command;
    
    if (os.platform() === 'win32') {
        // Windows 운영 체제인 경우
        command = 'docker-compose --project-name ${buttonValue} build --no-cache; docker-compose --project-name ${buttonValue} up -d';
    } else {
        // Linux 또는 macOS 운영 체제인 경우
        command = 'docker-compose --project-name ${buttonValue} build --no-cache && docker-compose --project-name ${buttonValue} up -d';
    }    
    // 클립보드에 명령어 복사
    navigator.clipboard.writeText(command).then(function () {
      const toastHtml = `
            <div class="toast-body">
              Docker installation command copied<br>
              ~$ ${command}
            </div>
        `;

      // 알림 창 표시
      toastEl.innerHTML = toastHtml;
      let toast = new bootstrap.Toast(toastEl);

      toast.show();
      // 아이콘 변경
      thisButton.innerHTML = 'copied <i class="bi bi-clipboard-check"></i>';
    }, function (err) {
      console.error('Async: Could not copy text: ', err);
    });

    // 알림 창이 사라진 후 아이콘 원래대로 변경
    toastEl.addEventListener('hidden.bs.toast', function () {
      thisButton.innerHTML = 'copy <i class="bi bi-clipboard"></i>';
    });
  }

</script>

<script>
  // 모든 툴팁 활성화
  let tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  let tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })
</script>
{% endblock %}
